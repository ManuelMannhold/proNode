@if (isExpanded()) {
<div class="sidebar-backdrop" (click)="isExpanded.set(false)"></div>
}
<div class="container sidebar-layout" [class.is-expanded]="isExpanded()">
    <div class="project-main-directory-header mobile-only-toggle" (click)="toggleSidebar()">
        <mat-icon>{{ isExpanded() ? 'menu_open' : 'menu' }}</mat-icon>
        <h4 *ngIf="isExpanded()">Menü schließen</h4>
    </div>
    <div class="sidebar-header">
        <button class="action-btn primary" (click)="addFolder()" matRipple>
            <mat-icon>create_new_folder</mat-icon>
            <span>Neuer Projektordner</span>
        </button>

        <button class="action-btn secondary" (click)="openCreateNoteDialog()" matRipple>
            <mat-icon>edit_note</mat-icon>
            <span>Neue Notiz</span>
        </button>
    </div>

    <div class="project-main-directory sidebar" cdkDropList (cdkDropListDropped)="drop($event)">
        @for (folder of folders(); track folder.id) {
        <div class="folder-group" @folderAnimation>
            <div class="folder-item" cdkDrag>
                <mat-icon cdkDragHandle class="drag-handle">drag_indicator</mat-icon>

                <mat-icon class="chevron" [class.rotated]="isFolderExpanded(folder.id)" (click)="toggleFolder(folder)">
                    chevron_right
                </mat-icon>

                <div class="folder-content">
                    @if (folder.isEditing) {
                    <input #nameInput class="folder-edit-input" [value]="folder.name"
                        (keyup.enter)="saveName(folder.id, $event)"
                        (keyup.esc)="noteService.removeFolderStub(folder.id)" (blur)="saveName(folder.id, $event)"
                        placeholder="Ordnername..." autofocus>
                    } @else {
                    <div class="folder-info-wrapper" (click)="selectFolder(folder.id)">
                        <mat-icon>{{ isFolderExpanded(folder.id) ? 'folder_open' : 'folder' }}</mat-icon>
                        <span class="folder-name" [matTooltip]="folder.name"
                            [matTooltipDisabled]="folder.name.length < 20">
                            {{ folder.name || 'Neuer Ordner' }}
                        </span>
                    </div>
                    }
                </div>

                <button mat-icon-button [matMenuTriggerFor]="folderMenu" class="more-btn"
                    (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #folderMenu="matMenu" class="custom-folder-menu" xPosition="before">
                    <button mat-menu-item (click)="noteService.setEditing(folder.id, true)">
                        <mat-icon>edit</mat-icon>
                        <span>Umbenennen</span>
                    </button>
                    <button mat-menu-item (click)="deleteFolder(folder.id)" style="color: #ff5252;">
                        <mat-icon style="color: #ff5252;">delete</mat-icon>
                        <span>Löschen</span>
                    </button>
                </mat-menu>
            </div>

            @if (isFolderExpanded(folder.id) && folder.notes && folder.notes.length > 0) {
            <div class="notes-sub-list">
                @for (note of folder.notes; track note.id) {
                <div class="note-item" (click)="selectNote(note)" [class.active]="note.id === selectedNote()?.id">
                    <mat-icon class="note-icon">description</mat-icon>
                    <span class="note-title">{{ note.title }}</span>

                    <button mat-icon-button [matMenuTriggerFor]="noteActionsMenu" (click)="$event.stopPropagation()"
                        class="more-btn">
                        <mat-icon>more_vert</mat-icon>
                    </button>

                    <mat-menu #noteActionsMenu="matMenu" class="custom-folder-menu">
                        <button mat-menu-item [matMenuTriggerFor]="moveSubMenu">
                            <mat-icon>drive_file_move</mat-icon>
                            <span>Verschieben nach...</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="onDeleteNote($event, note)" style="color: #ff5252;">
                            <mat-icon style="color: #ff5252;">delete_outline</mat-icon>
                            <span>Löschen</span>
                        </button>
                    </mat-menu>

                    <mat-menu #moveSubMenu="matMenu" class="custom-folder-menu">
                        @for (targetFolder of noteService.folders(); track targetFolder.id) {
                        @if (targetFolder.id !== folder.id) {
                        <button mat-menu-item (click)="noteService.moveNote(note.id, targetFolder.id)">
                            <mat-icon>folder</mat-icon>
                            <span>{{ targetFolder.name }}</span>
                        </button>
                        }
                        }
                    </mat-menu>
                </div>
                }
            </div>
            }
        </div>
        }
    </div>

    <button mat-icon-button (click)="logout()" class="logout-button">
        <mat-icon>logout</mat-icon>
    </button>
    <div class="sidebar-footer">
        <div class="legal-links">
            <a (click)="openLegal('impressum')">Impressum</a>
            <span class="separator">|</span>
            <a (click)="openLegal('datenschutz')">Datenschutz</a>
        </div>
    </div>
</div>

<mat-menu #profileMenu="matMenu" xPosition="after" yPosition="above" class="custom-profile-menu">
    <div class="menu-header-info">
        <div class="avatar-large">{{ getUserDisplayName(currentUser()).charAt(0) }}</div>
        <div class="text-info">
            <strong>{{ getUserDisplayName(currentUser()) }}</strong>
            <span>{{ currentUser()?.email }}</span>
        </div>
    </div>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="goToSettings()">
        <mat-icon>settings</mat-icon>
        <span>Einstellungen</span>
    </button>
    <button mat-menu-item (click)="logout()" class="logout-item">
        <mat-icon>logout</mat-icon>
        <span>Abmelden</span>
    </button>
</mat-menu>

<nav class="mobile-bottom-nav">
    <button class="nav-item" (click)="toggleSidebar()" [class.active]="isExpanded()">
        <mat-icon>folder</mat-icon>
        <span>Ordner</span>
    </button>
    <button class="nav-item action-button" (click)="openCreateNoteDialog()">
        <mat-icon>add</mat-icon>
    </button>
    <button class="nav-item" [matMenuTriggerFor]="profileMenu">
        <mat-icon>person</mat-icon>
        <span>Profil</span>
    </button>
</nav>